---
- hosts: all
  become: true

  tasks:
    - name: ensure repository key is installed
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

          #- name: ensure docker registry is available
          #apt_repository: repo='deb https://download.docker.com/linux/ubuntu bionic stable' state=present

        #- name: ensure docker and dependencies are installed
        #apt: name=docker-ce update_cache=yes
    - service: name=docker state=restarted
    - name: Install docker
      apt: name=docker-ce state=present
    - name: start docker
      service: name=docker state=started
    - name: get the docker file
      git: repo=https://github.com/kalyanramudu/demo1.git dest=/home/kalyan/dockerdir
    - name: build the dockerfile
      command: chdir=/home/kalyan/dockerdir docker build -t myimage:latest .
    - name: run the dockerimage
      command: docker run -itd --name mycontainer -P myimage:latest
    - name: delete running container because build is failed
      docker_container:
      name: mycontainer
      state: absent
      failed_when: >
        ("No such file or directory" in ret.stdout) or
        fatal: [172.31.81.42]: FAILED! or
        FATAL: command execution failed
      ignore_errors: True


